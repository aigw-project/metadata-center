# 数据一致性

## 概述

元数据中心在分布式和单机环境中都可能遇到数据一致性问题。
在分布式环境中，多副本同步延迟或节点故障可能导致数据不同步；在单机场景中，网络波动也可能使元数据未及时清理，从而影响统计准确性。

为解决这些问题，系统采用最终一致性模型，并通过周期性垃圾回收（GC）机制自动清理过期或孤立的数据，修复因网络或系统异常造成的统计偏差。

该策略确保系统在异常情况下能够自行恢复到一致状态，同时避免内存泄漏，保持统计信息的可靠性。



## GC流程

### 1. 周期性GC执行
```go
// GC默认每60秒运行一次
gcInterval = 60 * time.Second
```

### 2. 请求过期
- **默认过期时间**：660秒（11分钟）
- **过期检查**：比较请求创建时间与当前时间
- **清理过程**：移除过期请求并更新统计信息

## 并发处理

### 1. 线程安全操作
- 使用 `sync.Map` 进行并发访问
- 统计信息更新的原子操作

### 2. 延迟重试机制
```go
// 处理删除发生在添加之前的竞态条件
time.AfterFunc(time.Second, func() {
    if !ls.tryDeleteRequestStats(requestID) {
        logger.Warnf("延迟后仍未找到请求ID")
        return
    }
})
```

## 配置参数
### 参数说明

| 参数 | 环境变量 | 描述 | 默认值 |
|------|----------|------|--------|
| `gcInterval` | `METADATA_CENTER_LOAD_GC_INTERVAL` | GC执行间隔 | 60秒 |
| `requestExpireDuration` | `METADATA_CENTER_LOAD_REQ_EXPIRE` | 请求过期时间 | 660秒 |

### 配置调优
- 根据负载和内存约束调整 `gcInterval`
- 根据请求生命周期设置 `requestExpireDuration`

## 数据一致性保证

### 1. 最终一致性
- GC确保陈旧数据最终被移除
- 统计信息在过期窗口内保持准确

### 2. 内存管理
- 防止无限制的内存增长
- 自动清理孤立的条目
- 通过周期性GC实现高效内存使用